<div class="space-y-4 sm:space-y-5">
  @if (isLoadingSession()) {
    <div
      class="rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-gray-800/40 sm:p-5"
    >
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Loading your account details...
      </p>
    </div>
  } @else {
    <section
      class="rounded-xl border border-gray-200 bg-white p-4 dark:border-white/10 dark:bg-gray-900/60 sm:p-5"
    >
      <div
        class="mb-5 flex flex-col gap-4 sm:mb-6 sm:flex-row sm:items-center sm:justify-between"
      >
        <div>
          <h2
            class="text-lg font-semibold text-gray-900 dark:text-white"
          >
            Profile Overview
          </h2>
          <p
            class="mt-1 text-sm text-gray-600 dark:text-gray-400"
          >
            Your account metadata and profile identity.
          </p>
        </div>
        <span
          class="inline-flex w-fit rounded-full bg-primary-100 px-3 py-1 text-xs font-semibold text-primary-700 uppercase dark:bg-primary-900/40 dark:text-primary-300"
        >
          {{ user()?.role ?? 'user' }}
        </span>
      </div>

      <dl class="grid gap-3 sm:grid-cols-2 sm:gap-4">
        <div
          class="rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800/40 sm:p-4"
        >
          <dt
            class="text-xs font-semibold tracking-wide text-gray-500 uppercase dark:text-gray-400"
          >
            User ID
          </dt>
          <dd
            class="mt-2 break-all text-sm text-gray-900 dark:text-white"
          >
            {{ user()?.id }}
          </dd>
        </div>

        <div
          class="rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800/40 sm:p-4"
        >
          <dt
            class="text-xs font-semibold tracking-wide text-gray-500 uppercase dark:text-gray-400"
          >
            Email Verification
          </dt>
          <dd
            class="mt-2 text-sm font-medium"
            [class]="{
              'text-success-700 dark:text-success-300':
                user()?.emailVerified,
              'text-warning-700 dark:text-warning-300':
                !user()?.emailVerified,
            }"
          >
            {{
              user()?.emailVerified
                ? 'Verified'
                : 'Pending verification'
            }}
          </dd>
        </div>

        <div
          class="rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800/40 sm:p-4"
        >
          <dt
            class="text-xs font-semibold tracking-wide text-gray-500 uppercase dark:text-gray-400"
          >
            Member Since
          </dt>
          <dd
            class="mt-2 text-sm text-gray-900 dark:text-white"
          >
            {{ user()?.createdAt | date: 'dd MMM yyyy' }}
          </dd>
        </div>

        <div
          class="rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800/40 sm:p-4"
        >
          <dt
            class="text-xs font-semibold tracking-wide text-gray-500 uppercase dark:text-gray-400"
          >
            Application Roles
          </dt>
          <dd class="mt-2 text-sm text-gray-900 dark:text-white">
            @if (user()?.roles?.length) {
              <div class="flex flex-wrap gap-1.5">
                @for (role of user()!.roles; track role) {
                  <span
                    class="inline-flex rounded-full bg-gray-200 px-2.5 py-1 text-xs font-semibold text-gray-700 dark:bg-gray-700 dark:text-gray-200"
                  >
                    {{ role }}
                  </span>
                }
              </div>
            } @else {
              No explicit roles assigned
            }
          </dd>
        </div>
      </dl>
    </section>

    <section
      class="rounded-xl border border-gray-200 bg-white p-4 dark:border-white/10 dark:bg-gray-900/60 sm:p-5"
    >
      <h2
        class="text-lg font-semibold text-gray-900 dark:text-white"
      >
        Update Username
      </h2>
      <p
        class="mt-1 text-sm text-gray-600 dark:text-gray-400"
      >
        Your display name is visible in this app.
      </p>

      <form
        class="mt-4 space-y-4 sm:mt-5"
        [formGroup]="profileForm"
        (ngSubmit)="saveProfile()"
      >
        <div>
          <label
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            for="account-name"
          >
            Username
          </label>
          <input
            id="account-name"
            class="w-full"
            formControlName="name"
            type="text"
          />
          @if (
            profileForm.controls.name.invalid &&
            profileForm.controls.name.touched
          ) {
            <p
              class="mt-2 text-xs text-error-600 dark:text-error-300"
            >
              Use 2-120 characters, letters and numbers only.
            </p>
          }
        </div>

        <button
          class="inline-flex w-full items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-primary-700 disabled:opacity-60 sm:w-auto"
          type="submit"
          [disabled]="
            profileForm.invalid ||
            profileForm.controls.name.value.trim() ===
              (user()?.name ?? '') ||
            isSavingName()
          "
        >
          {{ isSavingName() ? 'Saving...' : 'Save Username' }}
        </button>
      </form>
    </section>

    <section
      class="rounded-xl border border-gray-200 bg-white p-4 dark:border-white/10 dark:bg-gray-900/60 sm:p-5"
    >
      <h2
        class="text-lg font-semibold text-gray-900 dark:text-white"
      >
        Update Email
      </h2>
      <p
        class="mt-1 text-sm text-gray-600 dark:text-gray-400"
      >
        We'll send a verification link to your new email address.
      </p>

      <form
        class="mt-4 space-y-4 sm:mt-5"
        [formGroup]="emailForm"
        (ngSubmit)="saveEmail()"
      >
        <div>
          <label
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            for="account-email"
          >
            New email
          </label>
          <input
            id="account-email"
            class="w-full"
            formControlName="email"
            type="email"
          />
          @if (
            emailForm.controls.email.invalid &&
            emailForm.controls.email.touched
          ) {
            <p
              class="mt-2 text-xs text-error-600 dark:text-error-300"
            >
              Enter a valid email address.
            </p>
          }
        </div>

        <button
          class="inline-flex w-full items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-primary-700 disabled:opacity-60 sm:w-auto"
          type="submit"
          [disabled]="
            emailForm.invalid ||
            emailForm.controls.email.value.trim() ===
              (user()?.email ?? '') ||
            isSavingEmail()
          "
        >
          {{
            isSavingEmail() ? 'Submitting...' : 'Update Email'
          }}
        </button>
      </form>
    </section>

    <section
      class="rounded-xl border border-error-200 bg-error-100/40 p-4 dark:border-error-800 dark:bg-error-900/10 sm:p-5"
    >
      <h2
        class="text-lg font-semibold text-error-700 dark:text-error-300"
      >
        Danger Zone
      </h2>
      <p
        class="mt-1 text-sm text-gray-700 dark:text-gray-300"
      >
        Deleting your account is irreversible. Type your current
        email to confirm.
      </p>

      <form
        class="mt-4 space-y-4 sm:mt-5"
        [formGroup]="deleteForm"
        (ngSubmit)="deleteAccount()"
      >
        <div>
          <label
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            for="delete-confirm-email"
          >
            Confirm email
          </label>
          <input
            id="delete-confirm-email"
            class="w-full border-error-300 focus:border-error-500 focus:ring-error-500/20 dark:border-error-700"
            formControlName="confirmationEmail"
            type="email"
          />
        </div>

        <button
          class="inline-flex w-full items-center justify-center rounded-lg bg-error-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-error-700 disabled:opacity-60 sm:w-auto"
          type="submit"
          [disabled]="deleteForm.invalid || isDeletingAccount()"
        >
          {{
            isDeletingAccount()
              ? 'Requesting...'
              : 'Delete Account'
          }}
        </button>
      </form>
    </section>
  }
</div>
