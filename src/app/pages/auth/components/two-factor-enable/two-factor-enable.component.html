<div
  class="bg-gray-100 dark:bg-gray-900 px-4 flex min-h-screen items-center justify-center"
>
  <div
    class="max-w-md space-y-8 bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl border-gray-200 dark:border-gray-700 w-full border"
  >
    @if (!isVerified()) {
      <div class="text-center">
        <h2
          class="text-3xl font-bold text-gray-900 dark:text-white"
        >
          Enable 2FA
        </h2>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
          Scan the QR code with your authenticator app
        </p>
      </div>

      @if (
        authService.twoFactorEnableData() &&
        authService.twoFactorEnableData()!.totpURI
      ) {
        <div class="space-y-6">
          <div
            class="bg-white p-4 rounded-lg border-gray-200 flex justify-center border"
          >
            <qrcode
              [qrdata]="
                authService.twoFactorEnableData()!.totpURI!
              "
              [width]="200"
              [errorCorrectionLevel]="'M'"
            ></qrcode>
          </div>

          <div
            class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg"
          >
            <p
              class="text-sm text-gray-600 dark:text-gray-400 mb-2"
            >
              Or enter manually:
            </p>
            <div
              class="bg-gray-200 dark:bg-gray-600 px-3 py-2 rounded flex items-center justify-between"
            >
              <code
                class="text-gray-900 dark:text-white text-sm break-all"
                >{{
                  authService.twoFactorEnableData()!.totpURI
                }}</code
              >
              <button
                class="ml-2 cursor-pointer text-primary-600 hover:text-primary-500 dark:text-primary-400 dark:hover:text-primary-300"
                type="button"
                (click)="
                  onCopyCode(
                    authService.twoFactorEnableData()!
                      .totpURI!
                  )
                "
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
              </button>
            </div>
          </div>

          <form
            class="space-y-4"
            [formGroup]="form"
            (ngSubmit)="onVerify()"
          >
            <div>
              <label
                class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block"
                for="code"
                >Verification Code</label
              >
              <input
                id="code"
                class="px-4 py-3 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white text-2xl tracking-widest placeholder-gray-500 dark:placeholder-gray-400 w-full border text-center focus:border-transparent focus:ring-2 focus:ring-primary-500 focus:outline-none"
                type="text"
                formControlName="code"
                maxlength="6"
                placeholder="000000"
              />
            </div>

            <button
              class="py-3 px-4 text-white font-semibold rounded-lg focus:ring-offset-white dark:focus:ring-offset-gray-800 disabled:bg-gray-400 disabled:text-gray-200 dark:disabled:bg-gray-600 dark:disabled:text-gray-400 w-full cursor-pointer bg-primary-600 transition duration-200 hover:bg-primary-700 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:outline-none disabled:cursor-not-allowed"
              type="submit"
              [disabled]="form.invalid"
            >
              Verify and Enable
            </button>
          </form>

          @if (errorMessage() !== '') {
            <div
              class="rounded-lg p-4 border border-error-200 bg-error-100 dark:border-error-800 dark:bg-error-900/20"
            >
              <div class="flex items-center">
                <svg
                  class="w-5 h-5 mr-3 text-error-400"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                    clip-rule="evenodd"
                  />
                </svg>
                <p
                  class="text-sm text-error-800 dark:text-error-200"
                >
                  {{ errorMessage() }}
                </p>
              </div>
            </div>
          }

          <div class="text-center">
            <p class="text-gray-600 dark:text-gray-400">
              <!--              TODO: Open dialog for confirm skip-->
              <!--                Protect your account with two-factor authentication-->
              <!--                Skipping this step makes your account significantly easier to compromise.-->
              <!--                We strongly recommend enabling it now — it only takes a minute.-->
              <button
                class="font-medium ml-1 cursor-pointer text-error-600 hover:text-error-500 dark:text-error-400 dark:hover:text-error-300"
                type="button"
                (click)="onContinue()"
              >
                Skip for now
              </button>
            </p>
          </div>
        </div>
      }
    } @else {
      <div class="text-center">
        <div class="mb-6">
          <div
            class="w-16 h-16 mx-auto flex items-center justify-center rounded-full bg-success-500"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>
        </div>
        <h2
          class="text-3xl font-bold text-gray-900 dark:text-white mb-2"
        >
          2FA Enabled!
        </h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
          Save these backup codes in a safe place
        </p>
      </div>

      @if (
        authService.twoFactorEnableData() &&
        authService.twoFactorEnableData()!.backupCodes
      ) {
        <div
          class="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg space-y-4"
        >
          <div class="flex items-center justify-between">
            <p
              class="text-sm text-gray-700 dark:text-gray-300 font-medium"
            >
              Backup Codes:
            </p>
            <button
              class="text-sm gap-1 flex cursor-pointer items-center text-primary-600 hover:text-primary-500 dark:text-primary-400 dark:hover:text-primary-300"
              type="button"
              (click)="onCopyAllCodes()"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                />
              </svg>
              Copy all
            </button>
          </div>
          <div class="gap-3 grid grid-cols-2">
            @for (
              code of authService.twoFactorEnableData()!
                .backupCodes;
              track code
            ) {
              <div
                class="bg-gray-200 dark:bg-gray-600 px-3 py-2 rounded flex items-center justify-between"
              >
                <code
                  class="text-gray-900 dark:text-white text-sm"
                  >{{ code }}</code
                >
                <button
                  class="ml-2 cursor-pointer text-primary-600 hover:text-primary-500 dark:text-primary-400 dark:hover:text-primary-300"
                  type="button"
                  (click)="onCopyCode(code)"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                    />
                  </svg>
                </button>
              </div>
            }
          </div>
          <p
            class="text-xs mt-4 text-warning-600 dark:text-warning-400"
          >
            ⚠️ These codes can be used to access your
            account if you lose access to your authenticator
            app
          </p>
        </div>
      }

      <button
        class="py-3 px-4 text-white font-semibold rounded-lg focus:ring-offset-white dark:focus:ring-offset-gray-800 w-full cursor-pointer bg-primary-600 transition duration-200 hover:bg-primary-700 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:outline-none"
        type="button"
        (click)="onContinue()"
      >
        Continue
      </button>
    }
  </div>
</div>
