<div class="space-y-5">
  <div
    class="gap-3 rounded-lg border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-gray-800/40 sm:flex-row sm:items-center sm:justify-between flex flex-col border"
  >
    <input
      class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-white sm:max-w-sm w-full border focus:border-primary-500 focus:ring-2 focus:ring-primary-500/25 focus:outline-none"
      placeholder="Search permissions..."
      type="text"
      [formControl]="searchControl"
    />
    <button
      class="rounded-lg px-4 py-2 text-sm font-semibold text-white bg-success-600 transition-colors hover:bg-success-700"
      type="button"
      (click)="openCreate()"
    >
      New Permission
    </button>
  </div>

  <div
    class="rounded-xl border-gray-200 dark:border-white/10 overflow-x-auto border"
  >
    <table
      class="divide-gray-200 dark:divide-white/10 w-full min-w-[760px] divide-y"
    >
      <thead class="bg-gray-50 dark:bg-gray-800/40">
        <tr>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            <button
              class="gap-1 inline-flex items-center"
              type="button"
              (click)="toggleSort('code')"
            >
              Code
              @if (sortColumn() === 'code') {
                <span>{{
                  sortDirection() === 'asc'
                    ? '↑'
                    : sortDirection() === 'desc'
                      ? '↓'
                      : '-'
                }}</span>
              }
            </button>
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            <button
              class="gap-1 inline-flex items-center"
              type="button"
              (click)="toggleSort('name')"
            >
              Name
              @if (sortColumn() === 'name') {
                <span>{{
                  sortDirection() === 'asc'
                    ? '↑'
                    : sortDirection() === 'desc'
                      ? '↓'
                      : '-'
                }}</span>
              }
            </button>
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            <button
              class="gap-1 inline-flex items-center"
              type="button"
              (click)="toggleSort('description')"
            >
              Description
              @if (sortColumn() === 'description') {
                <span>{{
                  sortDirection() === 'asc'
                    ? '↑'
                    : sortDirection() === 'desc'
                      ? '↓'
                      : '-'
                }}</span>
              }
            </button>
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody
        class="divide-gray-200 bg-white dark:divide-white/10 dark:bg-gray-900/40 divide-y"
      >
        @if (isLoading()) {
          <tr>
            <td
              class="px-4 py-6 text-sm text-gray-600 dark:text-gray-400"
              colspan="4"
            >
              Loading permissions...
            </td>
          </tr>
        } @else {
          @for (
            permission of filteredPermissions();
            track permission.id
          ) {
            <tr>
              <td
                class="px-4 py-4 text-sm font-mono text-primary-700 dark:text-primary-300"
              >
                {{ permission.code }}
              </td>
              <td
                class="px-4 py-4 text-sm font-semibold text-gray-900 dark:text-white"
              >
                {{ permission.name }}
              </td>
              <td
                class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300"
              >
                {{ permission.description || '-' }}
              </td>
              <td class="px-4 py-4 text-sm">
                <div class="gap-2 flex">
                  <button
                    class="rounded-md border-gray-300 px-2 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 border"
                    type="button"
                    (click)="openEdit(permission)"
                  >
                    Edit
                  </button>
                  <button
                    class="rounded-md px-2 py-1 text-xs font-semibold border border-error-300 text-error-700 hover:bg-error-100 dark:border-error-700 dark:text-error-300 dark:hover:bg-error-900/20"
                    type="button"
                    (click)="openDelete(permission)"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td
                class="px-4 py-6 text-sm text-gray-600 dark:text-gray-400"
                colspan="4"
              >
                No permissions found.
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>

@if (activeModal() !== 'none') {
  <div
    class="inset-0 bg-black/50 p-4 fixed z-50 flex items-center justify-center"
    (click)="closeModal()"
  >
    <div
      class="max-w-xl rounded-xl border-gray-200 bg-white p-5 shadow-xl dark:border-white/10 dark:bg-gray-900 max-h-[90vh] w-full overflow-y-auto border"
      (click)="$event.stopPropagation()"
    >
      @if (
        activeModal() === 'create' ||
        activeModal() === 'edit'
      ) {
        <form
          class="space-y-4"
          [formGroup]="permissionForm"
          (ngSubmit)="savePermission()"
        >
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-white"
          >
            {{
              activeModal() === 'create'
                ? 'Create Permission'
                : 'Edit Permission'
            }}
          </h3>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Code
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="code"
              type="text"
            />
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Name
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="name"
              type="text"
            />
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Description
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="description"
              type="text"
            />
          </div>
          <div class="gap-2 flex justify-end">
            <button
              class="rounded-lg border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 dark:border-gray-700 dark:text-gray-300 border"
              type="button"
              (click)="closeModal()"
            >
              Cancel
            </button>
            <button
              class="rounded-lg px-4 py-2 text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 disabled:opacity-60"
              type="submit"
              [disabled]="isSaving()"
            >
              {{ isSaving() ? 'Saving...' : 'Save' }}
            </button>
          </div>
        </form>
      }

      @if (
        activeModal() === 'delete' && selectedPermission()
      ) {
        <div class="space-y-4">
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-white"
          >
            Delete permission "{{
              selectedPermission()!.code
            }}"?
          </h3>
          <p
            class="text-sm text-gray-600 dark:text-gray-400"
          >
            This permission will be permanently removed.
          </p>
          <div class="gap-2 flex justify-end">
            <button
              class="rounded-lg border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 dark:border-gray-700 dark:text-gray-300 border"
              type="button"
              (click)="closeModal()"
            >
              Cancel
            </button>
            <button
              class="rounded-lg px-4 py-2 text-sm font-semibold text-white bg-error-600 hover:bg-error-700 disabled:opacity-60"
              type="button"
              [disabled]="isDeleting()"
              (click)="deletePermission()"
            >
              {{
                isDeleting()
                  ? 'Deleting...'
                  : 'Delete Permission'
              }}
            </button>
          </div>
        </div>
      }
    </div>
  </div>
}
