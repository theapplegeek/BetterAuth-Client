<div
  class="space-y-5"
  (click)="closeActionMenu()"
>
  <div
    class="gap-3 rounded-lg border-gray-200 bg-gray-50 p-4 dark:border-white/10 dark:bg-gray-800/40 flex flex-col border"
  >
    <form
      class="gap-3 md:grid-cols-[1fr_12rem_auto_auto] grid"
      [formGroup]="searchForm"
      (ngSubmit)="runSearch()"
    >
      <input
        class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-white w-full border focus:border-primary-500 focus:ring-2 focus:ring-primary-500/25 focus:outline-none"
        formControlName="searchValue"
        placeholder="Search users..."
        type="text"
      />
      <select
        class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-white w-full border focus:border-primary-500 focus:ring-2 focus:ring-primary-500/25 focus:outline-none"
        formControlName="searchField"
      >
        <option value="name">Name</option>
        <option value="email">Email</option>
      </select>
      <button
        class="rounded-lg px-4 py-2 text-sm font-semibold text-white bg-primary-600 transition-colors hover:bg-primary-700"
        type="submit"
      >
        Search
      </button>
      <button
        class="rounded-lg border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 border transition-colors"
        type="button"
        (click)="clearSearch()"
      >
        Clear
      </button>
    </form>

    <div class="flex items-center justify-between">
      <p class="text-xs text-gray-600 dark:text-gray-400">
        Manage application users with role and account
        lifecycle controls.
      </p>
      <button
        class="rounded-lg px-4 py-2 text-sm font-semibold text-white bg-success-600 transition-colors hover:bg-success-700"
        type="button"
        (click)="openCreate()"
      >
        New User
      </button>
    </div>
  </div>

  <div
    class="rounded-xl border-gray-200 dark:border-white/10 overflow-x-auto hide-scrollbar border"
  >
    <table
      class="divide-gray-200 dark:divide-white/10 w-full min-w-[980px] divide-y"
    >
      <thead class="bg-gray-50 dark:bg-gray-800/40">
        <tr>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            <button
              class="gap-1 inline-flex items-center"
              type="button"
              (click)="toggleSort('name')"
            >
              Name
              @if (sortColumn() === 'name') {
                <span>{{
                  sortDirection() === 'asc'
                    ? '↑'
                    : sortDirection() === 'desc'
                      ? '↓'
                      : '-'
                }}</span>
              }
            </button>
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            <button
              class="gap-1 inline-flex items-center"
              type="button"
              (click)="toggleSort('email')"
            >
              Email
              @if (sortColumn() === 'email') {
                <span>{{
                  sortDirection() === 'asc'
                    ? '↑'
                    : sortDirection() === 'desc'
                      ? '↓'
                      : '-'
                }}</span>
              }
            </button>
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            <button
              class="gap-1 inline-flex items-center"
              type="button"
              (click)="toggleSort('role')"
            >
              Role
              @if (sortColumn() === 'role') {
                <span>{{
                  sortDirection() === 'asc'
                    ? '↑'
                    : sortDirection() === 'desc'
                      ? '↓'
                      : '-'
                }}</span>
              }
            </button>
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            Status
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            Created
          </th>
          <th
            class="px-4 py-3 text-xs font-semibold tracking-wide text-gray-600 dark:text-gray-300 text-left uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody
        class="divide-gray-200 bg-white dark:divide-white/10 dark:bg-gray-900/40 divide-y"
      >
        @if (isLoadingUsers()) {
          <tr>
            <td
              class="px-4 py-6 text-sm text-gray-600 dark:text-gray-400"
              colspan="6"
            >
              Loading users...
            </td>
          </tr>
        } @else {
          @for (user of users(); track user.id) {
            <tr>
              <td
                class="px-4 py-4 text-sm text-gray-900 dark:text-white"
              >
                <p class="font-semibold">{{ user.name }}</p>
                @if (user.roles.length > 0) {
                  <p
                    class="mt-1 text-xs text-gray-500 dark:text-gray-400"
                  >
                    Roles:
                    {{ formatRoleList(user) }}
                  </p>
                }
              </td>
              <td
                class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300"
              >
                {{ user.email }}
              </td>
              <td
                class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300"
              >
                {{ user.role }}
              </td>
              <td class="px-4 py-4 text-sm">
                <span
                  class="px-2 py-1 text-xs font-semibold inline-flex rounded-full"
                  [class]="banStatusClass(user)"
                >
                  {{ user.banned ? 'Banned' : 'Active' }}
                </span>
              </td>
              <td
                class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300"
              >
                {{ user.createdAt | date: 'dd MMM yyyy' }}
              </td>
              <td
                class="px-4 py-4 text-left text-sm"
              >
                <div
                  class="relative inline-flex"
                  (click)="$event.stopPropagation()"
                >
                  <button
                    class="inline-flex items-center gap-1 rounded-lg border border-secondary-300 bg-white px-3 py-1.5 text-xs font-semibold text-secondary-700 transition hover:bg-secondary-100 dark:border-secondary-700 dark:bg-secondary-900 dark:text-secondary-200 dark:hover:bg-secondary-800"
                    type="button"
                    aria-label="Open user actions menu"
                    (click)="
                      toggleActionMenu(user.id, $event)
                    "
                  >
                    Actions
                    <span
                      class="icon-[heroicons--chevron-down] size-4"
                    ></span>
                  </button>

                  @if (
                    openActionMenuUserId() === user.id
                  ) {
                    <div
                      class="absolute left-0 top-10 z-30 w-52 rounded-lg border border-secondary-200 bg-white p-1 shadow-xl dark:border-secondary-700 dark:bg-secondary-900"
                    >
                      <button
                        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-secondary-700 hover:bg-secondary-100 dark:text-secondary-200 dark:hover:bg-secondary-800"
                        type="button"
                        (click)="openDetail(user)"
                      >
                        <span
                          class="icon-[heroicons--eye] size-4"
                        ></span>
                        Detail
                      </button>
                      <button
                        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-secondary-700 hover:bg-secondary-100 dark:text-secondary-200 dark:hover:bg-secondary-800"
                        type="button"
                        (click)="openEdit(user)"
                      >
                        <span
                          class="icon-[heroicons--pencil-square] size-4"
                        ></span>
                        Edit
                      </button>
                      <button
                        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-secondary-700 hover:bg-secondary-100 dark:text-secondary-200 dark:hover:bg-secondary-800"
                        type="button"
                        (click)="openPasswordEditor(user)"
                      >
                        <span
                          class="icon-[heroicons--key] size-4"
                        ></span>
                        Set Password
                      </button>
                      @if (user.banned) {
                        <button
                          class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-success-700 hover:bg-success-100 dark:text-success-300 dark:hover:bg-success-900/20"
                          type="button"
                          [disabled]="
                            updatingBanUserId() === user.id
                          "
                          (click)="unbanUser(user)"
                        >
                          <span
                            class="icon-[heroicons--check-circle] size-4"
                          ></span>
                          Unban
                        </button>
                      } @else {
                        <button
                          class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-error-700 hover:bg-error-100 dark:text-error-300 dark:hover:bg-error-900/20"
                          type="button"
                          (click)="openBanModal(user)"
                        >
                          <span
                            class="icon-[heroicons--no-symbol] size-4"
                          ></span>
                          Ban
                        </button>
                      }
                      <button
                        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-warning-700 hover:bg-warning-100 dark:text-warning-300 dark:hover:bg-warning-900/20"
                        type="button"
                        [disabled]="isImpersonatingUser()"
                        (click)="openImpersonateModal(user)"
                      >
                        <span
                          class="icon-[heroicons--user-circle] size-4"
                        ></span>
                        Impersonate
                      </button>
                      <button
                        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-secondary-700 hover:bg-secondary-100 dark:text-secondary-200 dark:hover:bg-secondary-800"
                        type="button"
                        (click)="openSessions(user)"
                      >
                        <span
                          class="icon-[heroicons--computer-desktop] size-4"
                        ></span>
                        Sessions
                      </button>
                      <div
                        class="my-1 h-px bg-secondary-200 dark:bg-secondary-700"
                      ></div>
                      <button
                        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium text-error-700 hover:bg-error-100 dark:text-error-300 dark:hover:bg-error-900/20"
                        type="button"
                        (click)="openDelete(user)"
                      >
                        <span
                          class="icon-[heroicons--trash] size-4"
                        ></span>
                        Delete
                      </button>
                    </div>
                  }
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td
                class="px-4 py-6 text-sm text-gray-600 dark:text-gray-400"
                colspan="6"
              >
                No users found.
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <div
    class="gap-3 rounded-lg border-gray-200 bg-gray-50 px-4 py-3 dark:border-white/10 dark:bg-gray-800/40 sm:flex-row sm:items-center sm:justify-between flex flex-col border"
  >
    <div
      class="gap-3 text-sm text-gray-600 dark:text-gray-400 flex items-center"
    >
      <span>
        Showing {{ visibleFrom() }} - {{ visibleTo() }} of
        {{ totalUsers() }}
      </span>
      <label class="gap-2 inline-flex items-center">
        <span>Per page</span>
        <select
          class="rounded-md border-gray-300 bg-white px-2 py-1 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-900 dark:text-white border"
          [value]="pageSize()"
          (change)="onPageSizeSelectChange($event)"
        >
          @for (size of pageSizeOptions; track size) {
            <option [value]="size">{{ size }}</option>
          }
        </select>
      </label>
    </div>

    <div class="gap-2 flex items-center">
      <button
        class="rounded-md border-gray-300 px-3 py-1 text-sm font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 border disabled:opacity-40"
        type="button"
        [disabled]="currentPage() <= 1"
        (click)="goToPage(1)"
      >
        First
      </button>
      <button
        class="rounded-md border-gray-300 px-3 py-1 text-sm font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 border disabled:opacity-40"
        type="button"
        [disabled]="currentPage() <= 1"
        (click)="goToPage(currentPage() - 1)"
      >
        Prev
      </button>
      <span
        class="text-sm text-gray-600 dark:text-gray-400"
      >
        Page {{ currentPage() }} / {{ totalPages() }}
      </span>
      <button
        class="rounded-md border-gray-300 px-3 py-1 text-sm font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 border disabled:opacity-40"
        type="button"
        [disabled]="currentPage() >= totalPages()"
        (click)="goToPage(currentPage() + 1)"
      >
        Next
      </button>
      <button
        class="rounded-md border-gray-300 px-3 py-1 text-sm font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 border disabled:opacity-40"
        type="button"
        [disabled]="currentPage() >= totalPages()"
        (click)="goToPage(totalPages())"
      >
        Last
      </button>
    </div>
  </div>
</div>

@if (activeModal() !== 'none') {
  <div
    class="app-modal-overlay"
    tabindex="0"
    (click)="closeModal()"
  >
    <div
      class="app-modal-panel max-w-2xl"
      (click)="$event.stopPropagation()"
    >
      @if (activeModal() === 'detail' && selectedUser()) {
        <div class="space-y-4">
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              User Detail
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <dl class="gap-3 sm:grid-cols-2 grid">
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Name
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.name }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Email
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.email }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Role
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.role }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                2FA
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{
                  selectedUser()!.twoFactorEnabled
                    ? 'Enabled'
                    : 'Disabled'
                }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Banned
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.banned ? 'Yes' : 'No' }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Created
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{
                  selectedUser()!.createdAt
                    | date: 'dd MMM yyyy, HH:mm'
                }}
              </dd>
            </div>
          </dl>

          <div class="mt-5 flex justify-end gap-2">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Close
              <span class="app-kbd">ENTER</span>
            </button>
          </div>
        </div>
      }

      @if (
        activeModal() === 'create' ||
        activeModal() === 'edit'
      ) {
        <form
          class="space-y-4"
          [formGroup]="userForm"
          (ngSubmit)="saveUser()"
        >
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              {{
                activeModal() === 'create'
                  ? 'Create User'
                  : 'Edit User'
              }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <div class="gap-4 sm:grid-cols-2 grid">
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Name
              </label>
              <input
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="name"
                type="text"
              />
            </div>
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Email
              </label>
              <input
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="email"
                type="email"
              />
            </div>
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Role
              </label>
              <select
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="role"
              >
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Image URL
              </label>
              <input
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="image"
                type="url"
              />
            </div>
            <div class="sm:col-span-2">
              <label
                class="gap-2 text-sm text-gray-700 dark:text-gray-300 inline-flex items-center"
              >
                <input
                  class="size-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                  formControlName="emailVerified"
                  type="checkbox"
                />
                Email verified
              </label>
            </div>
            @if (activeModal() === 'create') {
              <div class="sm:col-span-2">
                <label
                  class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
                >
                  Password
                </label>
                <input
                  class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                  formControlName="password"
                  type="password"
                />
              </div>
            }
          </div>

          <div>
            <p
              class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              RBAC Roles
            </p>
            <div class="gap-2 sm:grid-cols-2 grid">
              @for (role of roles(); track role.id) {
                <label
                  class="gap-2 rounded-lg border-gray-200 px-3 py-2 text-sm text-gray-700 dark:border-white/10 dark:text-gray-300 inline-flex items-center border"
                >
                  <input
                    class="size-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                    type="checkbox"
                    [checked]="isRoleSelected(role.id)"
                    (change)="
                      onRoleCheckboxChange(role.id, $event)
                    "
                  />
                  <span>{{ role.name }}</span>
                </label>
              }
            </div>
          </div>

          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-primary"
              type="submit"
              [disabled]="isSavingUser()"
            >
              {{ isSavingUser() ? 'Saving...' : 'Save' }}
              @if (!isSavingUser()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </form>
      }

      @if (activeModal() === 'password' && selectedUser()) {
        <form
          class="space-y-4"
          [formGroup]="passwordForm"
          (ngSubmit)="savePassword()"
        >
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Set Password for
              {{ selectedUser()!.name }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              New password
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="newPassword"
              type="password"
            />
          </div>
          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-primary"
              type="submit"
              [disabled]="isSavingPassword()"
            >
              {{
                isSavingPassword()
                  ? 'Saving...'
                  : 'Update Password'
              }}
              @if (!isSavingPassword()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </form>
      }

      @if (activeModal() === 'ban' && selectedUser()) {
        <form
          class="space-y-4"
          [formGroup]="banForm"
          (ngSubmit)="banUser()"
        >
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Ban {{ selectedUser()!.name }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Reason
            </label>
            <textarea
              class="w-full"
              formControlName="reason"
              rows="3"
            ></textarea>
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Duration (hours, 0 = permanent)
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="durationHours"
              min="0"
              type="number"
            />
          </div>
          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-danger"
              type="submit"
              [disabled]="isSavingBan()"
            >
              {{ isSavingBan() ? 'Saving...' : 'Ban User' }}
              @if (!isSavingBan()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </form>
      }

      @if (
        activeModal() === 'impersonate' &&
        selectedUser()
      ) {
        <div class="space-y-4">
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Impersonate
              {{ selectedUser()!.name }}?
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <p
            class="text-sm text-gray-600 dark:text-gray-400"
          >
            You will switch to this user's context.
          </p>
          <div class="flex justify-end gap-2">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-primary"
              type="button"
              [disabled]="isImpersonatingUser()"
              (click)="confirmImpersonation()"
            >
              {{
                isImpersonatingUser()
                  ? 'Switching...'
                  : 'Impersonate'
              }}
              @if (!isImpersonatingUser()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </div>
      }

      @if (activeModal() === 'sessions' && selectedUser()) {
        <div class="space-y-4">
          <div class="app-modal-header !mb-3">
            <h3 class="app-modal-title">
              Sessions for {{ selectedUser()!.name }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>

          @if (sessions().length > 0) {
            <div class="flex justify-end">
              <button
                class="app-btn-danger px-3 py-2 text-xs"
                type="button"
                [disabled]="isRevokingAllSessions()"
                (click)="revokeAllSessions()"
              >
                {{
                  isRevokingAllSessions()
                    ? 'Revoking...'
                    : 'Revoke All'
                }}
              </button>
            </div>
          }

          @if (isLoadingSessions()) {
            <p
              class="text-sm text-gray-600 dark:text-gray-400"
            >
              Loading sessions...
            </p>
          } @else {
            <div class="space-y-2">
              @for (
                session of sessions();
                track session.id
              ) {
                <div
                  class="rounded-lg border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800/40 flex items-center justify-between border"
                >
                  <div class="min-w-0">
                    <p
                      class="text-sm font-semibold text-gray-900 dark:text-white truncate"
                    >
                      {{
                        session.userAgent ||
                          'Unknown device'
                      }}
                    </p>
                    <p
                      class="text-xs text-gray-600 dark:text-gray-400"
                    >
                      Updated:
                      {{
                        session.updatedAt
                          | date: 'dd MMM yyyy, HH:mm'
                      }}
                    </p>
                  </div>
                  <button
                    class="text-sm font-semibold text-error-600 hover:text-error-700 dark:text-error-400 dark:hover:text-error-300"
                    type="button"
                    [disabled]="
                      revokingSessionToken() ===
                      (session.token || session.id)
                    "
                    (click)="revokeSession(session)"
                  >
                    {{
                      revokingSessionToken() ===
                      (session.token || session.id)
                        ? 'Revoking...'
                        : 'Revoke'
                    }}
                  </button>
                </div>
              } @empty {
                <p
                  class="text-sm text-gray-600 dark:text-gray-400"
                >
                  No active sessions found for this user.
                </p>
              }
            </div>
          }
        </div>
      }

      @if (activeModal() === 'delete' && selectedUser()) {
        <div class="space-y-4">
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Delete {{ selectedUser()!.name }}?
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <p
            class="text-sm text-gray-600 dark:text-gray-400"
          >
            This action is irreversible and removes the user
            account.
          </p>
          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-danger"
              type="button"
              [disabled]="isDeletingUser()"
              (click)="deleteSelectedUser()"
            >
              {{
                isDeletingUser()
                  ? 'Deleting...'
                  : 'Delete User'
              }}
              @if (!isDeletingUser()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </div>
      }

    </div>
  </div>
}

<app-confirm-dialog
  [open]="confirmDialog() !== undefined"
  [title]="confirmDialog()?.title ?? ''"
  [message]="confirmDialog()?.message ?? ''"
  [confirmLabel]="confirmDialog()?.confirmLabel ?? 'Confirm'"
  [tone]="confirmDialog()?.tone ?? 'danger'"
  (cancel)="closeConfirmDialog()"
  (confirm)="confirmDialogAction()"
></app-confirm-dialog>
