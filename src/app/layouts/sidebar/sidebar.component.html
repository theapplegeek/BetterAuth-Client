<!-- =========================================================
  MOBILE OVERLAY (only < lg, only when mobile sidebar is open)
========================================================== -->
@if (sidebarVisible()) {
  <div
    class="lg:hidden fixed inset-0 z-40 bg-black/60 transition-opacity duration-300"
    (click)="closeSidebar()"
  ></div>
}

<!-- =========================================================
  DESKTOP LAYOUT: animate grid columns
========================================================== -->
<div
  class="min-h-screen overflow-x-hidden lg:grid lg:grid-rows-1 transition-[grid-template-columns] duration-300 ease-out"
  [class]="{
    'lg:grid-cols-[18rem_1fr]': desktopSidebarOpen(),
    'lg:grid-cols-[0rem_1fr]': !desktopSidebarOpen()
  }"
>
  <!-- =======================================================
    SIDEBAR COLUMN (clips content when column shrinks)
  ======================================================== -->
  <div class="lg:overflow-hidden">
    <aside
      class="
        fixed inset-y-0 left-0 z-50 w-72
        transform transition-transform duration-300 ease-out
        bg-gray-900 border-r border-white/5
        -translate-x-full
        lg:static lg:inset-auto lg:z-auto lg:w-full lg:translate-x-0
      "
      [class.translate-x-0]="sidebarVisible()"
    >
      <!-- Fade/disable inner content on desktop collapse (keeps animations) -->
      <div
        class="flex h-screen grow flex-col gap-y-5 overflow-y-auto px-6
               transition-[opacity,transform] duration-300 ease-out"
        [class]="{
          'lg:opacity-100 lg:translate-x-0 lg:pointer-events-auto': desktopSidebarOpen(),
          'lg:opacity-0 lg:-translate-x-2 lg:pointer-events-none': !desktopSidebarOpen()
        }"
      >
        <!-- Logo row -->
        <div class="flex h-16 shrink-0 items-center justify-between">
          <img
            src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=500"
            alt="Your Company"
            class="h-8 w-auto"
          />

          <!-- Close button (mobile only, only when open) -->
          <button
            type="button"
            class="lg:hidden -m-2.5 p-2.5 text-white"
            [class.hidden]="!sidebarVisible()"
            (click)="closeSidebar()"
            aria-label="Close sidebar"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke-width="1.5" stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- NAV -->
        <nav class="flex flex-1 flex-col">
          <ul role="list" class="flex flex-1 flex-col">
            <li>
              <ul role="list" class="-mx-2 space-y-1">

                @for (item of navItems(); track item.id) {

                  <!-- LINK ITEM -->
                  @if (item.type === 'link') {
                    <li>
                      <a
                        [routerLink]="item.route"
                        routerLinkActive="bg-primary-600 text-white hover:!bg-primary-500"
                        class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-400 hover:bg-gray-800 hover:text-white"
                        (click)="closeSidebar()"
                      >
                        <div class="flex items-center gap-x-2">
                        @if (item.icon) {
                          <span class="size-5" [class]="item.icon"></span>
                        }
                        <span>{{ item.label }}</span>
                        </div>
                      </a>
                    </li>
                  }

                  <!-- GROUP / DROPDOWN ITEM -->
                  @if (item.type === 'group') {
                    <li>
                      <button
                        type="button"
                        [routerLink]="item.route"
                        routerLinkActive="!text-white"
                        class="w-full group flex items-center justify-between rounded-md p-2 text-sm/6 font-semibold text-gray-400 hover:bg-gray-800 hover:text-white"
                        (click)="toggleGroup(item.id)"
                      >
                        <span class="flex items-center gap-x-2">
                          @if (item.icon) {
                            <span class="size-5" [class]="item.icon"></span>
                          }
                          <span>{{ item.label }}</span>
                        </span>

                        <!-- Chevron -->
                        <svg
                          class="size-4 transform transition-transform duration-200 ease-out"
                          [class.rotate-180]="isGroupOpen(item.id)"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          aria-hidden="true"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </button>

                      <!-- Animated dropdown (grid trick) -->
                      <div
                        class="grid transition-[grid-template-rows] duration-300 ease-out"
                        [class.grid-rows-[0fr]]="!isGroupOpen(item.id)"
                        [class.grid-rows-[1fr]]="isGroupOpen(item.id)"
                      >
                        <div class="overflow-hidden">
                          <ul
                            class="mt-1 ml-2 space-y-1 border-l border-white/10 pl-2 transition-opacity duration-200 ease-out"
                            [class.opacity-0]="!isGroupOpen(item.id)"
                            [class.opacity-100]="isGroupOpen(item.id)"
                          >
                            @for (child of item.children; track child.id) {
                              <li>
                                <a
                                  [routerLink]="child.route"
                                  routerLinkActive="bg-primary-600 text-white hover:!bg-primary-500"
                                  class="block rounded-md p-2 text-sm/6 font-semibold text-gray-400 hover:bg-gray-800 hover:text-white"
                                  (click)="closeSidebar()"
                                >
                                  <div class="flex items-center gap-x-2">
                                    @if (child.icon) {
                                      <span class="size-5" [class]="child.icon"></span>
                                    }
                                    {{ child.label }}
                                  </div>
                                </a>
                              </li>
                            }
                          </ul>
                        </div>
                      </div>
                    </li>
                  }
                }

              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
  </div>

  <!-- =======================================================
    CONTENT COLUMN
  ======================================================== -->
  <div class="min-w-0">
    <header
      class="sticky top-0 z-30 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-900/5 dark:border-white/5 bg-white dark:bg-gray-900 px-4 shadow-xs sm:gap-x-6 sm:px-6 lg:px-8"
    >
      <!-- Mobile hamburger -->
      <button
        type="button"
        class="-m-2.5 p-2.5 lg:hidden cursor-pointer"
        (click)="changeSidebarVisibility()"
        aria-label="Open sidebar"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="size-6">
          <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Desktop collapse/expand -->
      <button
        type="button"
        class="hidden lg:flex -m-2.5 p-2.5 cursor-pointer"
        (click)="toggleDesktopSidebar()"
        aria-label="Toggle sidebar"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="size-6">
          <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="flex-1"></div>

      <div class="flex flex-1 gap-x-4 justify-end self-stretch">
        <div class="flex items-center gap-x-2">
          <!-- Separator -->
          <!--<div aria-hidden="true" class="h-6 w-px bg-white/20"></div>-->

          <!-- User -->
          <button class="flex items-center" ngMenuTrigger #origin #trigger="ngMenuTrigger" [menu]="formatMenu()">
            <span class="icon-[heroicons--user] size-5" translate="no" aria-hidden="true"></span>
            <span
              aria-hidden="true"
              class="ml-2 text-sm/6 font-semibold capitalize">
                {{ username() }}
            </span>
          </button>
          <ng-template
            [cdkConnectedOverlayOpen]="trigger.expanded()"
            [cdkConnectedOverlay]="{ origin, usePopover: 'inline' }"
            [cdkConnectedOverlayPositions]="[
              { originX: 'start', originY: 'bottom', overlayX: 'start', overlayY: 'top', offsetY: 4 },
              { originX: 'start', originY: 'top',    overlayX: 'start', overlayY: 'bottom', offsetY: -4 },
              { originX: 'end',   originY: 'bottom', overlayX: 'end',   overlayY: 'top', offsetY: 4 },
              { originX: 'end',   originY: 'top',    overlayX: 'end',   overlayY: 'bottom', offsetY: -4 }
            ]"
            [cdkConnectedOverlayPush]="true"
            [cdkConnectedOverlayFlexibleDimensions]="true"
            [cdkConnectedOverlayGrowAfterOpen]="true"
            [cdkConnectedOverlayViewportMargin]="8"
            cdkAttachPopoverAsChild>
            <div ngMenu class="menu w-[15rem] rounded-md shadow-xl border border-gray-200/50 dark:border-white/30 p-[0.25rem] bg-white dark:bg-gray-900" #formatMenu="ngMenu">
              <ng-template ngMenuContent>
                <div class="flex flex-col gap-y-2">
                  <div class="flex flex-col p-2 text-black dark:text-white">
                    <span class="text-xs">Signed in as</span>
                    <span class="text-md mt-1">{{ username() }}</span>
                  </div>
                  <div role="separator" aria-orientation="horizontal" class="border-t border-gray-200/50 dark:border-white/10"></div>
                  <div ngMenuItem value="Settings" class="flex items-center gap-1 p-2 cursor-pointer rounded-sm border border-white dark:border-gray-900 text-black dark:text-gray-400 dark:hover:text-white hover:bg-gray-100/50 dark:hover:bg-gray-800">
                    <span class="icon-[heroicons--user] size-5" translate="no" aria-hidden="true"></span>
                    <span class="flex flex-1 text-[1rem] opacity-[0.875rem] ml-2">Profile</span>
                  </div>
                  <div ngMenuItem value="Settings" class="flex items-center gap-1 p-2 cursor-pointer rounded-sm border border-white dark:border-gray-900 text-black dark:text-gray-400 dark:hover:text-white hover:bg-gray-100/50 dark:hover:bg-gray-800">
                    <span class="icon-[heroicons--cog-8-tooth] size-5" translate="no" aria-hidden="true"></span>
                    <span class="flex flex-1 text-[1rem] opacity-[0.875rem] ml-2">Settings</span>
                  </div>
                  <div role="separator" aria-orientation="horizontal" class="border-t border-gray-200/50 dark:border-white/10"></div>
                  <div ngMenuItem value="Logout" class="flex items-center gap-1 p-2 cursor-pointer rounded-sm border border-white dark:border-gray-900 text-red-500 hover:text-red-400 hover:bg-gray-100/50 dark:hover:bg-gray-800"
                       (click)="signOut()">
                    <span class="icon-[heroicons--arrow-right-end-on-rectangle] size-5" translate="no" aria-hidden="true"></span>
                    <span class="flex flex-1 text-[1rem] opacity-[0.875rem] ml-2">Logout</span>
                  </div>
                </div>
              </ng-template>
            </div>
          </ng-template>

          <!--&lt;!&ndash; Sign out &ndash;&gt;
          <div class="relative ml-2">
            <button
              class="relative flex items-center cursor-pointer"
              (click)="signOut()"
              aria-label="Sign out"
            >
              <span class="flex items-center text-red-400 hover:text-red-600 transition-colors">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15M12 9l3 3m0 0-3 3m3-3H2.25"
                  />
                </svg>
              </span>
            </button>
          </div>-->
        </div>
      </div>
    </header>

    <main>
      <div class="p-4 sm:p-6 lg:p-8">
        <router-outlet></router-outlet>
      </div>
    </main>
  </div>
</div>
