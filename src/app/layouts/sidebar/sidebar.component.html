<!-- =========================================================
  MOBILE OVERLAY (only < lg, only when mobile sidebar is open)
========================================================== -->
@if (sidebarVisible()) {
  <div
    class="lg:hidden inset-0 bg-black/60 fixed z-40 transition-opacity duration-300"
    (click)="closeSidebar()"
  ></div>
}

<!-- =========================================================
  DESKTOP LAYOUT: animate grid columns
========================================================== -->
<div
  class="lg:grid lg:grid-rows-1 ease-out min-h-screen overflow-x-hidden transition-[grid-template-columns] duration-300"
  [class]="{
    'lg:grid-cols-[18rem_1fr]': desktopSidebarOpen(),
    'lg:grid-cols-[0rem_1fr]': !desktopSidebarOpen(),
  }"
>
  <!-- =======================================================
    SIDEBAR COLUMN (clips content when column shrinks)
  ======================================================== -->
  <div class="lg:overflow-hidden">
    <aside
      class="inset-y-0 left-0 w-72 ease-out bg-gray-900 border-white/5 lg:static lg:inset-auto lg:z-auto lg:w-full lg:translate-x-0 fixed z-50 -translate-x-full transform border-r transition-transform duration-300"
      [class.translate-x-0]="sidebarVisible()"
    >
      <!-- Fade/disable inner content on desktop collapse (keeps animations) -->
      <div
        class="gap-y-5 px-6 ease-out flex h-screen grow flex-col overflow-y-auto transition-[opacity,transform] duration-300"
        [class]="{
          'lg:opacity-100 lg:translate-x-0 lg:pointer-events-auto':
            desktopSidebarOpen(),
          'lg:opacity-0 lg:-translate-x-2 lg:pointer-events-none':
            !desktopSidebarOpen(),
        }"
      >
        <!-- Logo row -->
        <div
          class="h-16 flex shrink-0 items-center justify-between"
        >
          <img
            class="h-8 w-auto"
            src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=500"
            alt="Your Company"
          />

          <!-- Close button (mobile only, only when open) -->
          <button
            class="lg:hidden -m-2.5 p-2.5 text-white"
            type="button"
            aria-label="Close sidebar"
            [class.hidden]="!sidebarVisible()"
            (click)="closeSidebar()"
          >
            <svg
              class="size-6"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18 18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- NAV -->
        <nav class="flex flex-1 flex-col">
          <ul
            class="flex flex-1 flex-col"
            role="list"
          >
            <li>
              <ul
                class="-mx-2 space-y-1"
                role="list"
              >
                @for (item of navItems(); track item.id) {
                  <!-- LINK ITEM -->
                  @if (item.type === 'link') {
                    <li>
                      <a
                        class="group gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-400 hover:bg-gray-800 hover:text-white flex cursor-pointer"
                        routerLinkActive="bg-primary-600 text-white hover:!bg-primary-500"
                        [routerLinkActiveOptions]="{
                          exact: item.exact ?? false,
                        }"
                        [routerLink]="item.route"
                        (click)="closeSidebar()"
                      >
                        <div
                          class="gap-x-2 flex items-center"
                        >
                          @if (item.icon) {
                            <span
                              class="size-5"
                              [class]="item.icon"
                            ></span>
                          }
                          <span>{{ item.label }}</span>
                        </div>
                      </a>
                    </li>
                  }

                  <!-- GROUP / DROPDOWN ITEM -->
                  @if (item.type === 'group') {
                    <li>
                      <button
                        class="group rounded-md p-2 text-sm/6 font-semibold text-gray-400 hover:bg-gray-800 hover:text-white flex w-full cursor-pointer items-center justify-between"
                        type="button"
                        [class.text-white]="isGroupActive(item)"
                        [class.bg-gray-800]="isGroupActive(item)"
                        (click)="toggleGroup(item.id)"
                      >
                        <span
                          class="gap-x-2 flex items-center"
                        >
                          @if (item.icon) {
                            <span
                              class="size-5"
                              [class]="item.icon"
                            ></span>
                          }
                          <span>{{ item.label }}</span>
                        </span>

                        <!-- Chevron -->
                        <svg
                          class="size-4 ease-out transform transition-transform duration-200"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          aria-hidden="true"
                          [class.rotate-180]="
                            isGroupOpen(item.id)
                          "
                        >
                          <path
                            fill-rule="evenodd"
                            d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </button>

                      <!-- Animated dropdown (grid trick) -->
                      <div
                        class="ease-out grid transition-[grid-template-rows] duration-300"
                        [class.grid-rows-[0fr]]="
                          !isGroupOpen(item.id)
                        "
                        [class.grid-rows-[1fr]]="
                          isGroupOpen(item.id)
                        "
                      >
                        <div class="overflow-hidden">
                          <ul
                            class="mt-1 ml-2 space-y-1 border-white/10 pl-2 ease-out border-l transition-opacity duration-200"
                            [class.opacity-0]="
                              !isGroupOpen(item.id)
                            "
                            [class.opacity-100]="
                              isGroupOpen(item.id)
                            "
                          >
                            @for (child of item.children;
                              track child.id) {
                              <li>
                                <a
                                  class="rounded-md p-2 text-sm/6 font-semibold text-gray-400 hover:bg-gray-800 hover:text-white block cursor-pointer"
                                  routerLinkActive="bg-primary-600 text-white hover:!bg-primary-500"
                                  [routerLinkActiveOptions]="{
                                    exact:
                                      child.exact ?? true,
                                  }"
                                  [routerLink]="child.route"
                                  (click)="closeSidebar()"
                                >
                                  <div
                                    class="gap-x-2 flex items-center"
                                  >
                                    @if (child.icon) {
                                      <span
                                        class="size-5"
                                        [class]="child.icon"
                                      ></span>
                                    }
                                    {{ child.label }}
                                  </div>
                                </a>
                              </li>
                            }
                          </ul>
                        </div>
                      </div>
                    </li>
                  }
                }
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
  </div>

  <!-- =======================================================
    CONTENT COLUMN
  ======================================================== -->
  <div class="min-w-0 h-screen flex flex-col">
    <header
      class="top-0 h-16 gap-x-4 border-gray-900/5 dark:border-white/5 bg-white dark:bg-gray-900 px-4 shadow-xs sm:gap-x-6 sm:px-6 lg:px-8 sticky z-30 flex shrink-0 items-center border-b"
    >
      <!-- Mobile hamburger -->
      <button
        class="-m-2.5 p-2.5 lg:hidden cursor-pointer"
        type="button"
        aria-label="Open sidebar"
        (click)="changeSidebarVisibility()"
      >
        <svg
          class="size-6"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          aria-hidden="true"
        >
          <path
            d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <!-- Desktop collapse/expand -->
      <button
        class="lg:flex -m-2.5 p-2.5 hidden cursor-pointer"
        type="button"
        aria-label="Toggle sidebar"
        (click)="toggleDesktopSidebar()"
      >
        <svg
          class="size-6"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          aria-hidden="true"
        >
          <path
            d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <div class="flex-1"></div>

      <div
        class="gap-x-4 flex flex-1 justify-end self-stretch"
      >
        <div class="gap-x-2 flex items-center">
          <!-- Separator -->
          <!--<div aria-hidden="true" class="h-6 w-px bg-white/20"></div>-->

          <!-- User -->
          <app-profile-menu></app-profile-menu>
        </div>
      </div>
    </header>

    <main class="flex-1 min-h-0">
      <div class="p-4 sm:p-6 lg:p-8 h-full">
        <router-outlet></router-outlet>
      </div>
    </main>
  </div>
</div>
