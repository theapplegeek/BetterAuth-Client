<div class="app-modal-panel max-w-2xl">
      @if (activeModal() === 'detail' && selectedUser()) {
        <div class="space-y-4">
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              User Detail
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <dl class="gap-3 sm:grid-cols-2 grid">
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Name
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.name }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Email
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.email }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Role
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.role }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                2FA
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{
                  selectedUser()!.twoFactorEnabled
                    ? 'Enabled'
                    : 'Disabled'
                }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Banned
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{ selectedUser()!.banned ? 'Yes' : 'No' }}
              </dd>
            </div>
            <div>
              <dt
                class="text-xs text-gray-500 dark:text-gray-400"
              >
                Created
              </dt>
              <dd
                class="text-sm text-gray-900 dark:text-white"
              >
                {{
                  selectedUser()!.createdAt
                    | date: 'dd MMM yyyy, HH:mm'
                }}
              </dd>
            </div>
          </dl>

          <div class="mt-5 flex justify-end gap-2">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Close
              <span class="app-kbd">ENTER</span>
            </button>
          </div>
        </div>
      }

      @if (
        activeModal() === 'create' ||
        activeModal() === 'edit'
      ) {
        <form
          class="space-y-4"
          [formGroup]="userForm"
          (ngSubmit)="saveUser()"
        >
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              {{
                activeModal() === 'create'
                  ? 'Create User'
                  : 'Edit User'
              }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <div class="gap-4 sm:grid-cols-2 grid">
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Name
              </label>
              <input
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="name"
                type="text"
              />
            </div>
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Email
              </label>
              <input
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="email"
                type="email"
              />
            </div>
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Role
              </label>
              <select
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="role"
              >
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div>
              <label
                class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
              >
                Image URL
              </label>
              <input
                class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                formControlName="image"
                type="url"
              />
            </div>
            <div class="sm:col-span-2">
              <label
                class="gap-2 text-sm text-gray-700 dark:text-gray-300 inline-flex items-center"
              >
                <input
                  class="size-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                  formControlName="emailVerified"
                  type="checkbox"
                />
                Email verified
              </label>
            </div>
            @if (activeModal() === 'create') {
              <div class="sm:col-span-2">
                <label
                  class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
                >
                  Password
                </label>
                <input
                  class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
                  formControlName="password"
                  type="password"
                />
              </div>
            }
          </div>

          <div>
            <p
              class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              RBAC Roles
            </p>
            <div class="gap-2 sm:grid-cols-2 grid">
              @for (role of roles(); track role.id) {
                <label
                  class="inline-flex items-center gap-2 rounded-lg border border-slate-600/70 bg-slate-800/45 px-3 py-2 text-sm text-slate-100 transition hover:bg-slate-700/55"
                >
                  <input
                    class="size-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                    type="checkbox"
                    [checked]="isRoleSelected(role.id)"
                    (change)="
                      onRoleCheckboxChange(role.id, $event)
                    "
                  />
                  <span>{{ role.name }}</span>
                </label>
              }
            </div>
          </div>

          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-primary"
              type="submit"
              [disabled]="isSavingUser()"
            >
              {{ isSavingUser() ? 'Saving...' : 'Save' }}
              @if (!isSavingUser()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </form>
      }

      @if (activeModal() === 'password' && selectedUser()) {
        <form
          class="space-y-4"
          [formGroup]="passwordForm"
          (ngSubmit)="savePassword()"
        >
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Set Password for
              {{ selectedUser()!.name }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              New password
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="newPassword"
              type="password"
            />
          </div>
          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-primary"
              type="submit"
              [disabled]="isSavingPassword()"
            >
              {{
                isSavingPassword()
                  ? 'Saving...'
                  : 'Update Password'
              }}
              @if (!isSavingPassword()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </form>
      }

      @if (activeModal() === 'ban' && selectedUser()) {
        <form
          class="space-y-4"
          [formGroup]="banForm"
          (ngSubmit)="banUser()"
        >
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Ban {{ selectedUser()!.name }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Reason
            </label>
            <textarea
              class="w-full"
              formControlName="reason"
              rows="3"
            ></textarea>
          </div>
          <div>
            <label
              class="mb-1 text-sm font-medium text-gray-700 dark:text-gray-300 block"
            >
              Duration (hours, 0 = permanent)
            </label>
            <input
              class="rounded-lg border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-700 dark:bg-gray-800 dark:text-white w-full border"
              formControlName="durationHours"
              min="0"
              type="number"
            />
          </div>
          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-danger"
              type="submit"
              [disabled]="isSavingBan()"
            >
              {{ isSavingBan() ? 'Saving...' : 'Ban User' }}
              @if (!isSavingBan()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </form>
      }

      @if (
        activeModal() === 'impersonate' &&
        selectedUser()
      ) {
        <div class="space-y-4">
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Impersonate
              {{ selectedUser()!.name }}?
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <p
            class="text-sm text-gray-600 dark:text-gray-400"
          >
            You will switch to this user's context.
          </p>
          <div class="flex justify-end gap-2">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-primary"
              type="button"
              [disabled]="isImpersonatingUser()"
              (click)="confirmImpersonation()"
            >
              {{
                isImpersonatingUser()
                  ? 'Switching...'
                  : 'Impersonate'
              }}
              @if (!isImpersonatingUser()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </div>
      }

      @if (activeModal() === 'sessions' && selectedUser()) {
        <div class="space-y-4">
          <div class="app-modal-header !mb-3">
            <h3 class="app-modal-title">
              Sessions for {{ selectedUser()!.name }}
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>

          @if (sessions().length > 0) {
            <div class="flex justify-end">
              <button
                class="app-btn-danger px-3 py-2 text-xs"
                type="button"
                [disabled]="isRevokingAllSessions()"
                (click)="revokeAllSessions()"
              >
                {{
                  isRevokingAllSessions()
                    ? 'Revoking...'
                    : 'Revoke All'
                }}
              </button>
            </div>
          }

          @if (isLoadingSessions()) {
            <p
              class="text-sm text-gray-600 dark:text-gray-400"
            >
              Loading sessions...
            </p>
          } @else {
            <div class="space-y-2">
              @for (
                session of sessions();
                track session.id
              ) {
                <div
                  class="rounded-lg border-gray-200 bg-gray-50 p-3 dark:border-white/10 dark:bg-gray-800/40 flex items-center justify-between border"
                >
                  <div class="min-w-0">
                    <p
                      class="text-sm font-semibold text-gray-900 dark:text-white truncate"
                    >
                      {{
                        session.userAgent ||
                          'Unknown device'
                      }}
                    </p>
                    <p
                      class="text-xs text-gray-600 dark:text-gray-400"
                    >
                      Updated:
                      {{
                        session.updatedAt
                          | date: 'dd MMM yyyy, HH:mm'
                      }}
                    </p>
                  </div>
                  <button
                    class="text-sm font-semibold text-error-600 hover:text-error-700 dark:text-error-400 dark:hover:text-error-300"
                    type="button"
                    [disabled]="
                      revokingSessionToken() ===
                      (session.token || session.id)
                    "
                    (click)="revokeSession(session)"
                  >
                    {{
                      revokingSessionToken() ===
                      (session.token || session.id)
                        ? 'Revoking...'
                        : 'Revoke'
                    }}
                  </button>
                </div>
              } @empty {
                <p
                  class="text-sm text-gray-600 dark:text-gray-400"
                >
                  No active sessions found for this user.
                </p>
              }
            </div>
          }
        </div>
      }

      @if (activeModal() === 'delete' && selectedUser()) {
        <div class="space-y-4">
          <div class="app-modal-header">
            <h3 class="app-modal-title">
              Delete {{ selectedUser()!.name }}?
            </h3>
            <button
              class="app-modal-close"
              type="button"
              aria-label="Close dialog"
              (click)="closeModal()"
            >
              <span
                class="icon-[heroicons--x-mark] size-5"
              ></span>
            </button>
          </div>
          <p
            class="text-sm text-gray-600 dark:text-gray-400"
          >
            This action is irreversible and removes the user
            account.
          </p>
          <div class="gap-2 flex justify-end">
            <button
              class="app-btn-secondary"
              type="button"
              (click)="closeModal()"
            >
              Cancel
              <span class="app-kbd">ESC</span>
            </button>
            <button
              class="app-btn-danger"
              type="button"
              [disabled]="isDeletingUser()"
              (click)="deleteSelectedUser()"
            >
              {{
                isDeletingUser()
                  ? 'Deleting...'
                  : 'Delete User'
              }}
              @if (!isDeletingUser()) {
                <span class="app-kbd">ENTER</span>
              }
            </button>
          </div>
        </div>
      }
</div>
